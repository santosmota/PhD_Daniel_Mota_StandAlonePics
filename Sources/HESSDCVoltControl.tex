%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% DC Voltage Controller Grid Converter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\tikzstyle{block} = [draw, rectangle, fill=white, minimum height=1cm, minimum width=1cm, font=\footnotesize]
\tikzstyle{caixa} = [rectangle, draw, fill=white, text width=1.25cm, text centered, minimum height=1cm, font=\footnotesize ] %,text width=2cm minimum width=2.2cm
\tikzstyle{caixinha} = [rectangle, draw, fill=white, text width=0.75cm, text centered, minimum height=1cm, font=\footnotesize ] %,text width=2cm minimum width=2.2cm
\tikzstyle{sum} = [draw, circle, font=\footnotesize]
\tikzstyle{junction} = [coordinate]
\tikzstyle{fonte} = [font=\footnotesize]
\begin{tikzpicture}[auto, >=latex']

%summing point voltages
\node at (-4,0) [sum] (soma) {$\Sigma$};

%Primary, secondary, and inertial response
\node at (-2.5,0) [caixinha] (Kg) {$k_g$};
\node at (0,0) [caixinha] (Kp) {$k_p$};
%\node at (0,-1.5) [rectangle, draw, fill=white, text width=2.5cm, text centered, minimum height=1cm, font=\footnotesize] (Ti) {nti-windup: $\dfrac{1}{sT_i}$};
\node at (0,-1.5) [caixinha] (Ti) {$\dfrac{1}{sT_i}$};
\node at (Ti.south) [fonte, anchor=north] () {Integrator with anti-windup};

%\node at (-1.25,0.5) [fonte, anchor=south] () {Proportional-integral regulator}; 

%summing point currents
\node at (2,0) [sum] (somaI) {$\Sigma$};

%limiters
\draw (2.5,-0.75) to (2.9,-0.75) to (3.1,0.75) to (3.5,0.75);
\node at (2.7,-0.75) [fonte, anchor=north] () {$\overset{*}{i}_{rd_{\min}}$}; 
\node at (3.3,0.75) [fonte, anchor=south] () {$\overset{*}{i}_{rd_{\max}}$}; 
\node at (3.2,-2) [fonte, anchor=south] () {Dynamic limits};

%lines to summing point voltages
\draw [->] (-5,0) to node[fonte, anchor=south, pos=0.0] () {$1$} node[fonte, anchor=south, pos=0.8] () {$-$} (soma);
\draw [->] (-5,-1) -| node[fonte, anchor=south, pos=0.0] () {$\widehat{v}_{dc}$} node[fonte, anchor=east, pos=0.8] () {$+$} (soma);

% other lines from blocks the power summation point
\draw [->] (soma) to (Kg);
\draw [->] (Kg) to (Kp);
\draw [->] (Kp) to node[fonte, anchor=south, pos=0.85] () {$+$} (somaI);
\draw [->] (somaI) to node[fonte, anchor=south, pos=1] () {$\overset{*}{i}_{rd}$} (4.5,0);
\fill ($(Kg.east) + (0.25,0)$) circle [radius=1pt];
\draw [->] ($(Kg.east) + (0.25,0)$) |- (Ti);
\draw [->] (Ti) -| node[fonte, anchor=east, pos=0.9] () {$+$} (somaI);

\node at (4.5,-0.3) [fonte] () {Reference to GC's};
\node at (4.5,-0.6) [fonte] () {inner-loop current};
\node at (4.5,-0.9) [fonte] () {regulator};

% feedforward
\draw [->] ($(somaI.north) + (-0.5,0.5)$) -|  node[fonte, anchor=east, pos=0.0] () {$\widehat{i}_{es}$} node[fonte, anchor=west, pos=0.85] () {$+$} (somaI);
\node at ($(somaI.north) + (-0.5,0.7)$) [fonte, anchor=south] () {Feed forward}; 
\end{tikzpicture}
